<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proyecto Grua HNG</title>
    <!-- Favicon del icono de la página -->
    <link
      rel="shortcut icon"
      href="./resources/favicon.ico"
      type="image/x-icon"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    
    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="js/utiles.js" defer></script>

  </head>
  <body>
    <div class="container-fluid" id="app">
      <!-- No logeado -->
      <div v-if="!logeado" class="d-flex justify-content-center align-items-center vh-100">
        <div class="card p-4 shadow-lg" style="width: 30rem; border-radius: 15px;">
          <div class="card-body text-center">
            <!-- Título -->
            <h1 class="card-title mb-4">GRUA MUNICIPAL</h1>
            <p class="card-text text-muted mb-4">Inicia sesión para continuar</p>
              <!-- Campo de Email -->
              <div class="mb-3">
                <label for="email" class="form-label">Email:</label>
                <input
                  type="text"
                  class="form-control form-control-lg"
                  v-model="email"
                  name="email"
                  id="email"
                  placeholder="Ingresa tu email"
                />
              </div>
      
              <!-- Campo de Contraseña -->
              <div class="mb-3">
                <label for="contrasena" class="form-label">Contraseña:</label>
                <input
                  type="password"
                  class="form-control form-control-lg"
                  v-model="contrasena"
                  name="contrasena"
                  id="contrasena"
                  placeholder="Ingresa tu contraseña"
                />
              </div>
      
              <!-- Botón de Inicio de Sesión -->
              <button type="button" @click="intentoLogin" class="btn btn-primary btn-lg w-100 mt-4">
                Iniciar Sesión
              </button>
            </p>
          </div>
        </div>
      </div>
      <!-- Logueado -->
      <div v-else>
        <!-- Header y nav -->
        <div>
          <header class="bg-primary py-4 shadow-lg">
            <div class="container">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="fas fa-truck-pickup text-white fa-2x mr-3"></i>
                  <h1 class="text-white mb-0">Panel Administración Grua Municipal</h1>
                </div>
                <!-- Botón cerrar sesión + nombre del usuario -->
                <div class="d-flex align-items-center">
                  <i class="fas fa-user-circle text-white fa-lg mr-2"></i>
                  <span class="text-white">{{usuario.email}}</span>
                  <button @click="cerrarSesion" class="btn btn-outline-light ml-3">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                  </button>
                </div>
              </div>
            </div>
          </header>
          <nav class="bg-dark shadow">
            <div class="container">
              <ul class="nav nav-pills py-3 justify-content-center">
                <li class="nav-item mx-2">
                  <button type="button" @click="mostrarLiquidacion" class="nav-link text-black hover-effect d-flex align-items-center">
                    <i class="fas fa-file-invoice me-2 p-2"></i>
                    <span>Retiradas</span>
                  </button>
                </li>
                <li class="nav-item mx-2" v-if="isAdmin()">
                  <button type="button" @click="mostrarRetirada" class="nav-link text-black hover-effect d-flex align-items-center">
                    <i class="fas fa-truck me-2 p-2"></i>
                    <span>Vehículos</span>
                  </button>
                </li>
                <li class="nav-item mx-2" v-if="isAdmin()">
                  <button type="button" @click="mostrarUsuarios" class="nav-link text-black hover-effect d-flex align-items-center">
                    <i class="fas fa-users me-2 p-2"></i>
                    <span>Gestión Usuarios</span>
                  </button>
                </li>
              </ul>
            </div>
          </nav>

          <!-- Alert message container -->
          <div v-if="mensajeAlerta" class="alert alert-success fade show text-center" role="alert"></div>
            {{ mensajeAlerta }}
            <button type="button" class="close" @click="mensajeAlerta = ''" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <main class="flex-grow-1 bg-light py-4">
            <div class="container-fluid">
              <section>
                <!-- Retiradas (admin) -->
                <div v-if="pantalla === 'liquidacion'">
                  <h1 class="text-center">Gestión de Retiradas</h1>
                  <!-- Botón para abrir el modal -->
                  <button class="btn btn-primary mt-3 w-100 p-3 mb-3 align-text-center" @click="abrirModalLiquidacion">
                    Crear Retirada
                  </button>

                  <!-- Tabla para mostrar las liquidaciones -->
                  <div class="table-responsive">
                    <div>
                      <!-- Search and length controls -->
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <div class="dataTables_length">
                            <label>
                              Show 
                              <select v-model="pageSizeLiquidaciones" class="form-select form-select-sm">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                              </select>
                              entries
                            </label>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="dataTables_filter">
                            <label>
                              Search:
                              <input type="search" v-model="searchQueryLiquidaciones" class="form-control form-control-sm">
                            </label>
                          </div>
                        </div>
                      </div>

                      <!-- Table -->
                      <table class="table table-striped table-bordered shadow-sm text-center">
                        <thead class="table-dark">
                          <tr>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('id')">ID <span v-if="currentSortLiquidaciones === 'id'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('id_retirada')">ID Vehículo <span v-if="currentSortLiquidaciones === 'id_retirada'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('nombre')">Nombre <span v-if="currentSortLiquidaciones === 'nombre'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('nif')">NIF <span v-if="currentSortLiquidaciones === 'nif'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('domicilio')">Domicilio <span v-if="currentSortLiquidaciones === 'domicilio'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('poblacion')">Población <span v-if="currentSortLiquidaciones === 'poblacion'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('provincia')">Provincia <span v-if="currentSortLiquidaciones === 'provincia'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('permiso')">Permiso <span v-if="currentSortLiquidaciones === 'permiso'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('fecha')">Fecha <span v-if="currentSortLiquidaciones === 'fecha'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('agente')">Agente <span v-if="currentSortLiquidaciones === 'agente'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('opciones_pago')">Opciones Pago <span v-if="currentSortLiquidaciones === 'opciones_pago'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('importe_retirada')">Importe Retirada <span v-if="currentSortLiquidaciones === 'importe_retirada'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('importe_deposito')">Importe Deposito <span v-if="currentSortLiquidaciones === 'importe_deposito'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" @click="sortByLiquidaciones('total')">Total <span v-if="currentSortLiquidaciones === 'total'">{{ currentSortDirLiquidaciones === 'asc' ? '▲' : '▼' }}</span></th>
                            <th scope="col" class="align-middle text-center" colspan="3">Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="liquidacion in paginatedAndFilteredLiquidaciones" class="align-middle">
                            <td class="text-center">{{ liquidacion.id }}</td>
                            <td class="text-center">{{ liquidacion.id_retirada }}</td>
                            <td class="text-center">{{ liquidacion.nombre }}</td>
                            <td class="text-center">{{ liquidacion.nif }}</td>
                            <td class="text-center">{{ liquidacion.domicilio }}</td>
                            <td class="text-center">{{ liquidacion.poblacion }}</td>
                            <td class="text-center">{{ liquidacion.provincia }}</td>
                            <td class="text-center">{{ liquidacion.permiso }}</td>
                            <td class="text-center">{{ liquidacion.fecha }}</td>
                            <td class="text-center">{{ liquidacion.agente }}</td>
                            <td class="text-center">{{ liquidacion.opciones_pago }}</td>
                            <td class="text-center">{{ liquidacion.importe_retirada }}</td>
                            <td class="text-center">{{ liquidacion.importe_deposito }}</td>
                            <td class="text-center">{{ liquidacion.total }}</td>
                            <td class="text-center">
                              <button @click="formularioEditarLiquidacion(liquidacion.id)" 
                                      class="btn btn-primary btn-sm" 
                                      data-toggle="modal" 
                                      data-target="#liquidacionEditarModal">
                                <i class="fas fa-edit me-1"></i> Editar
                              </button>
                            </td>
                            <td class="text-center">
                              <button @click="formularioEliminarLiquidacion(liquidacion.id)" 
                                      class="btn btn-danger btn-sm" 
                                      data-toggle="modal" 
                                      data-target="#liquidacionEliminarModal">
                                <i class="fas fa-trash-alt me-1"></i> Eliminar
                              </button>
                            </td>
                            <td class="text-center">
                              <button @click="generarPDFLiquidacion(liquidacion)" class="btn btn-warning btn-sm">
                                <i class="fas fa-file-pdf me-1"></i> Generar PDF
                              </button>
                            </td>
                          </tr>
                        </tbody>
                      </table>

                      <!-- Pagination -->
                      <div class="row">
                        <div class="col-md-6">
                          <div class="dataTables_info">
                            Showing {{ startIndexLiquidaciones + 1 }} to {{ endIndexLiquidaciones }} of {{ filteredLiquidaciones.length }} entries
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="dataTables_paginate">
                            <ul class="pagination justify-content-end">
                              <li class="page-item" :class="{ disabled: currentPageLiquidaciones === 1 }">
                                <a class="page-link" href="#" @click.prevent="currentPageLiquidaciones--">Previous</a>
                              </li>
                              <li v-for="page in totalPagesLiquidaciones" 
                                  class="page-item"
                                  :class="{ active: currentPageLiquidaciones === page }">
                                <a class="page-link" href="#" @click.prevent="currentPageLiquidaciones = page">{{ page }}</a>
                              </li>
                              <li class="page-item" :class="{ disabled: currentPageLiquidaciones === totalPagesLiquidaciones }">
                                <a class="page-link" href="#" @click.prevent="currentPageLiquidaciones++">Next</a>
                              </li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Modales -->

                  <!-- Modal añadir retirada -->
                  <div class="modal fade" id="liquidacionCrearModal" tabindex="-1" role="dialog" aria-labelledby="liquidacionCrearModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-fullscreen" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="liquidacionCrearModalLabel">Creación de Retirada</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <form @submit.prevent="crearLiquidacion">
                              <div class="modal-body">
                                <div class="container-fluid">
                                  <div class="row">
                                    <!-- Left Column -->
                                    <div class="col-md-6">
                                      <div class="form-group mb-3">
                                        <label for="id" class="form-label">ID Vehiculo:</label>
                                        <select v-model="formLiquidacion.id_retirada" class="form-control" id="id_retirada" @change="rellenarFormCreacionVehiculo" required>
                                          <option v-for="retirada in retiradas_disponibles" :value="retirada.id">
                                              {{ retirada.id }} - {{ retirada.matricula }}
                                          </option>
                                        </select>
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="nombre" class="form-label">Nombre:</label>
                                        <input type="text" v-model="formLiquidacion.nombre" class="form-control" id="nombre" 
                                          required pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="El nombre debe contener solo letras y espacios (2-50 caracteres)">
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="nif" class="form-label">NIF:</label>
                                        <input type="text" v-model="formLiquidacion.nif" class="form-control" id="nif" 
                                          required pattern="[0-9]{8}[A-Z]{1}" title="Formato NIF: 8 números seguidos de una letra mayúscula">
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="domicilio" class="form-label">Domicilio:</label>
                                        <input type="text" v-model="formLiquidacion.domicilio" class="form-control" id="domicilio" 
                                          required minlength="5" maxlength="100" title="El domicilio debe tener entre 5 y 100 caracteres">
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="poblacion" class="form-label">Población:</label>
                                        <input type="text" v-model="formLiquidacion.poblacion" class="form-control" id="poblacion" 
                                          required pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="La población debe contener solo letras y espacios (2-50 caracteres)">
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="provincia" class="form-label">Provincia:</label>
                                        <input type="text" v-model="formLiquidacion.provincia" class="form-control" id="provincia" 
                                          required pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="La provincia debe contener solo letras y espacios (2-50 caracteres)">
                                      </div>
                                    </div>

                                    <!-- Right Column -->
                                    <div class="col-md-6">
                                      <div class="form-group mb-3">
                                        <label for="permiso" class="form-label">Permiso:</label>
                                        <input type="text" v-model="formLiquidacion.permiso" class="form-control" id="permiso" 
                                          required title="El permiso debe contener letras mayúsculas, números y guiones (2-20 caracteres)">
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="fecha" class="form-label">Fecha Entrada Vehículo:</label>
                                        <input type="datetime-local" v-model="fecha_entrada_vehiculo" class="form-control" id="fecha" required readonly>
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="fecha" class="form-label">Fecha Salida:</label>
                                        <input type="datetime-local" v-model="formLiquidacion.fecha" class="form-control" id="fecha" 
                                          @change="calcularPrecioHoras" required>
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="agente" class="form-label">Agente:</label>
                                        <input type="text" v-model="formLiquidacion.agente" class="form-control" id="agente" 
                                          required pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="El nombre del agente debe contener solo letras y espacios (2-50 caracteres)">
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="importe_retirada" class="form-label">Importe Retirada:</label>
                                        <input type="number" disabled v-model="formLiquidacion.importe_retirada" class="form-control" id="importe_retirada" required>
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="importe_deposito" class="form-label">Importe Deposito:</label>
                                        <input type="number" disabled v-model="formLiquidacion.importe_deposito" 
                                          class="form-control" id="importe_deposito" required
                                          step="0.01" min="0" max="9999.99" 
                                          title="El importe debe ser un número positivo con hasta 2 decimales">
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="total" class="form-label">Total:</label>
                                        <input type="number" disabled v-model="formLiquidacion.total" 
                                          class="form-control" id="total" required
                                          step="0.01" min="0" max="99999.99" 
                                          title="El total debe ser un número positivo con hasta 2 decimales">
                                      </div>

                                      <div class="form-group mb-3">
                                        <label for="opciones_pago" class="form-label">Opciones Pago:</label>
                                        <select v-model="formLiquidacion.opciones_pago" class="form-control" id="opciones_pago" required>
                                          <option value="Metálico">Metálico</option>
                                          <option value="Tarjeta">Tarjeta</option>
                                          <option value="Bizum">Bizum</option>
                                        </select>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                                  <button type="submit" class="btn btn-primary">Crear liquidación</button>
                              </div>
                            </form>
                        </div>
                    </div>
                  </div>
                   <!-- Modal eliminar retirada-->
                  <div class="modal fade" id="liquidacionEliminarModal" tabindex="-1" role="dialog" aria-labelledby="liquidacionEliminarModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="liquidacionEliminarModalLabel">Modificación de liquidacion</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                              <div class="row">
                                <div class="col-md-12 mb-6">
                                  <h5>¿Estás seguro de que quieres eliminar la retirada Nº{{liquidacion_seleccionada.id}}?</h5>
                                  <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                      ID Vehículo:
                                      <span class="text-end">{{liquidacion_seleccionada.id}}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                      Nombre:
                                      <span class="text-end">{{liquidacion_seleccionada.nombre}}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                      Fecha:
                                      <span class="text-end">{{liquidacion_seleccionada.fecha}}</span>
                                    </li>
                                  </ul>
                                </div>
                              </div>
                          </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" @click="eliminarLiquidacion">Eliminar retirada</button>
                            </div>
                        </div>
                    </div>
                  </div>
                  <!-- Modal editar retirada-->
                  <div class="modal fade" id="liquidacionEditarModal" tabindex="-1" role="dialog" aria-labelledby="liquidacionEditarModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-fullscreen" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="liquidacionEditarModalLabel">Modificación de Entrega</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <form @submit.prevent="editarLiquidacion">
                          <div class="modal-body">
                            <div class="container-fluid">
                              <div class="row">
                                <!-- Left Column -->
                                <div class="col-md-6">
                                  <div class="form-group mb-3">
                                    <label for="nombre" class="form-label">Nombre:</label>
                                    <input type="text" v-model="liquidacion_seleccionada.nombre" class="form-control" id="nombre" required 
                                      pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="El nombre debe contener solo letras y espacios (2-50 caracteres)">
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="nif" class="form-label">NIF:</label>
                                    <input type="text" v-model="liquidacion_seleccionada.nif" class="form-control" id="nif" required 
                                      pattern="[0-9]{8}[A-Z]{1}" title="Formato NIF: 8 números seguidos de una letra mayúscula">
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="domicilio" class="form-label">Domicilio:</label>
                                    <input type="text" v-model="liquidacion_seleccionada.domicilio" class="form-control" id="domicilio" required 
                                      minlength="5" maxlength="100" title="El domicilio debe tener entre 5 y 100 caracteres">
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="poblacion" class="form-label">Población:</label>
                                    <input type="text" v-model="liquidacion_seleccionada.poblacion" class="form-control" id="poblacion" required 
                                      pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="La población debe contener solo letras y espacios (2-50 caracteres)">
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="provincia" class="form-label">Provincia:</label>
                                    <input type="text" v-model="liquidacion_seleccionada.provincia" class="form-control" id="provincia" required 
                                      pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="La provincia debe contener solo letras y espacios (2-50 caracteres)">
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="permiso" class="form-label">Permiso:</label>
                                    <input type="text" v-model="liquidacion_seleccionada.permiso" class="form-control" id="permiso" required 
                                      pattern="[A-Z0-9\-]{2,20}" title="El permiso debe contener letras mayúsculas, números y guiones (2-20 caracteres)">
                                  </div>
                                </div>

                                <!-- Right Column -->
                                <div class="col-md-6">
                                  <div class="form-group mb-3">
                                    <label for="fecha" class="form-label">Fecha Entrada Vehículo:</label>
                                    <input type="datetime-local" v-model="fecha_entrada_vehiculo" class="form-control" id="fecha" required readonly>
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="fecha" class="form-label">Fecha Salida:</label>
                                    <input type="datetime-local" v-model="liquidacion_seleccionada.fecha" class="form-control" id="fecha" 
                                      @change="calcularPrecioHorasEdicion" required>
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="agente" class="form-label">Agente:</label>
                                    <input type="text" v-model="liquidacion_seleccionada.agente" class="form-control" id="agente" required 
                                      pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="El nombre del agente debe contener solo letras y espacios (2-50 caracteres)">
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="importe_retirada" class="form-label">Importe Retirada:</label>
                                    <input type="number" step="0.01" min="0" max="9999.99" v-model="liquidacion_seleccionada.importe_retirada" disabled
                                      class="form-control" id="importe_retirada" required title="El importe debe ser un número positivo con hasta 2 decimales">
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="importe_deposito" class="form-label">Importe Deposito:</label>
                                    <input type="number" step="0.01" min="0" max="9999.99" v-model="liquidacion_seleccionada.importe_deposito" disabled
                                      class="form-control" id="importe_deposito" required title="El importe debe ser un número positivo con hasta 2 decimales">
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="total" class="form-label">Total:</label>
                                    <input type="number" step="0.01" min="0" max="99999.99" v-model="liquidacion_seleccionada.total" disabled
                                      class="form-control" id="total" required title="El total debe ser un número positivo con hasta 2 decimales">
                                  </div>

                                  <div class="form-group mb-3">
                                    <label for="opciones_pago" class="form-label">Opciones Pago:</label>
                                    <select v-model="liquidacion_seleccionada.opciones_pago" class="form-control" id="opciones_pago" required>
                                      <option value="Metálico">Metálico</option>
                                      <option value="Tarjeta">Tarjeta</option>
                                      <option value="Bizum">Bizum</option>
                                    </select>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar cambios</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Vehiculos -->
                <div v-if="pantalla === 'retiradas'">
                    <h1 class="text-center">Gestión de Vehículos</h1>
                    <!-- Botón para abrir el modal -->
                    <button class="btn btn-primary mt-3 w-100 p-3 mb-3 align-text-center" 
                    @click.prevent="abrirModalRetirada">
                      Agregar Vehículo
                    </button>

                    <!-- Tabla para mostrar los vehiculos -->
                    <div class="table-responsive">
                      <div>
                        <!-- Search and length controls -->
                        <div class="row mb-3">
                          <div class="col-md-6">
                            <div class="dataTables_length">
                              <label>
                                Show 
                                <select v-model="pageSizeRetiradas" class="form-select form-select-sm">
                                  <option value="10">10</option>
                                  <option value="25">25</option>
                                  <option value="50">50</option>
                                  <option value="100">100</option>
                                </select>
                                entries
                              </label>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="dataTables_filter">
                              <label>
                                Search:
                                <input type="search" v-model="searchQueryRetiradas" class="form-control form-control-sm">
                              </label>
                            </div>
                          </div>
                        </div>
                        <!-- Table -->
                        <table class="table table-bordered table-striped shadow-sm">
                          <thead class="table-dark">
                            <tr>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('id')">
                                ID
                                <span v-if="currentSortRetiradas === 'id'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('fecha_entrada')">
                                Fecha de entrada
                                <span v-if="currentSortRetiradas === 'fecha_entrada'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('fecha_salida')">
                                Fecha de salida
                                <span v-if="currentSortRetiradas === 'fecha_salida'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('lugar')">
                                Lugar
                                <span v-if="currentSortRetiradas === 'lugar'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('direccion')">
                                Dirección
                                <span v-if="currentSortRetiradas === 'direccion'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('agente')">
                                Agente
                                <span v-if="currentSortRetiradas === 'agente'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('matricula')">
                                Matrícula
                                <span v-if="currentSortRetiradas === 'matricula'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('marca')">
                                Marca
                                <span v-if="currentSortRetiradas === 'marca'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('modelo')">
                                Modelo
                                <span v-if="currentSortRetiradas === 'modelo'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('color')">
                                Color
                                <span v-if="currentSortRetiradas === 'color'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('motivo')">
                                Motivo
                                <span v-if="currentSortRetiradas === 'motivo'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('tipo_vehiculo')">
                                Tipo Vehículo
                                <span v-if="currentSortRetiradas === 'tipo_vehiculo'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('grua')">
                                Grúa
                                <span v-if="currentSortRetiradas === 'grua'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" @click="sortByRetiradas('estado')">
                                Estado
                                <span v-if="currentSortRetiradas === 'estado'">
                                  {{ currentSortDirRetiradas === 'asc' ? '▲' : '▼' }}
                                </span>
                              </th>
                              <th scope="col" class="align-middle text-center" colspan="3">Acciones</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr v-for="retirada in paginatedAndFilteredRetiradas" 
                                class="align-middle">
                              <td class="text-center">{{ retirada.id }}</td>
                              <td class="text-center">{{ retirada.fecha_entrada }}</td>
                              <td class="text-center">{{ retirada.fecha_salida }}</td>
                              <td class="text-center">{{ retirada.lugar }}</td>
                              <td class="text-center">{{ retirada.direccion }}</td>
                              <td class="text-center">{{ retirada.agente }}</td>
                              <td class="text-center">{{ retirada.matricula }}</td>
                              <td class="text-center">{{ retirada.marca }}</td>
                              <td class="text-center">{{ retirada.modelo }}</td>
                              <td class="text-center">{{ retirada.color }}</td>
                              <td class="text-center">{{ retirada.motivo }}</td>
                              <td class="text-center">{{ retirada.tipo_vehiculo }}</td>
                              <td class="text-center">{{ retirada.grua }}</td>
                              <td class="text-center" :class="{'table-primary': retirada.estado === 'En depósito', 
                              'table-success': retirada.estado === 'Retirado'}">{{ retirada.estado }}</td>
                              <td class="text-center">
                                <button @click="formularioEditarRetirada(retirada.id)" 
                                        class="btn btn-primary btn-sm" 
                                        data-toggle="modal" 
                                        data-target="#retiradaEditarModal">
                                  <i class="fas fa-edit me-1"></i> Editar
                                </button>
                              </td>
                              <td class="text-center">
                                <button @click="formularioEliminarRetirada(retirada.id)" 
                                        class="btn btn-danger btn-sm" 
                                        data-toggle="modal" 
                                        data-target="#retiradaEliminarModal">
                                  <i class="fas fa-trash-alt me-1"></i> Eliminar
                                </button>
                              </td>
                              
                              <td class="text-center" v-if="retirada.estado == 'En depósito'">
                                <button @click="abrirModalLiquidacionEspecifico(retirada.id)"
                                  class="btn btn-warning btn-sm">
                                  <i class="fas fa-file me-1"></i> Facturar
                                </button>
                              </td>
                            </tr>
                          </tbody>
                        </table>

                        <!-- Pagination -->
                        <div class="row">
                          <div class="col-md-6">
                            <div class="dataTables_info">
                              Showing {{ startIndexRetiradas + 1 }} to {{ endIndexRetiradas }} of {{ filteredRetiradas.length }} entries
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="dataTables_paginate">
                              <ul class="pagination justify-content-end">
                                <li class="page-item" :class="{ disabled: currentPageRetiradas === 1 }">
                                  <a class="page-link" href="#" @click.prevent="currentPageRetiradas--">Previous</a>
                                </li>
                                <li v-for="page in totalPagesRetiradas" 
                                    class="page-item"
                                    :class="{ active: currentPageRetiradas === page }">
                                  <a class="page-link" href="#" @click.prevent="currentPageRetiradas = page">{{ page }}</a>
                                </li>
                                <li class="page-item" :class="{ disabled: currentPageRetiradas === totalPagesRetiradas }">
                                  <a class="page-link" href="#" @click.prevent="currentPageRetiradas++">Next</a>
                                </li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                    
                      <!-- Modal retirada especifica -->
                    <div class="modal fade" id="liquidacionCrearModal" tabindex="-1" role="dialog" aria-labelledby="liquidacionCrearModalLabel" aria-hidden="true">
                      <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="liquidacionCrearModalLabel">Creación de Retirada</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <form @submit.prevent="crearLiquidacion">
                            <div class="modal-body">
                              <div class="container-fluid">
                                <div class="row">
                                  <!-- Left column -->
                                  <div class="col-md-6">
                                    <div class="form-group mb-2">
                                      <label for="id" class="form-label">ID Vehiculo:</label>
                                      <input type="text" v-model="formLiquidacion.id_retirada" class="form-control form-control-sm" id="id_retirada" disabled>
                                    </div>
                                    
                                    <div class="form-group mb-2">
                                      <label for="nombre" class="form-label">Nombre:</label>
                                      <input type="text" v-model="formLiquidacion.nombre" class="form-control form-control-sm" id="nombre" 
                                        required pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="El nombre debe contener solo letras y espacios (2-50 caracteres)">
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="nif" class="form-label">NIF:</label>
                                      <input type="text" v-model="formLiquidacion.nif" class="form-control form-control-sm" id="nif"
                                        required pattern="[0-9]{8}[A-Z]{1}" title="Formato NIF: 8 números seguidos de una letra mayúscula">
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="domicilio" class="form-label">Domicilio:</label>
                                      <input type="text" v-model="formLiquidacion.domicilio" class="form-control form-control-sm" id="domicilio"
                                        required minlength="5" maxlength="100" title="El domicilio debe tener entre 5 y 100 caracteres">
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="poblacion" class="form-label">Población:</label>
                                      <input type="text" v-model="formLiquidacion.poblacion" class="form-control form-control-sm" id="poblacion"
                                        required pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="La población debe contener solo letras y espacios (2-50 caracteres)">
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="provincia" class="form-label">Provincia:</label>
                                      <input type="text" v-model="formLiquidacion.provincia" class="form-control form-control-sm" id="provincia"
                                        required pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="La provincia debe contener solo letras y espacios (2-50 caracteres)">
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="permiso" class="form-label">Permiso:</label>
                                      <input type="text" v-model="formLiquidacion.permiso" class="form-control form-control-sm" id="permiso"
                                        required title="El permiso debe contener letras mayúsculas, números y guiones (2-20 caracteres)">
                                    </div>
                                  </div>

                                  <!-- Right column -->
                                  <div class="col-md-6">
                                    <div class="form-group mb-2">
                                      <label for="fecha_entrada" class="form-label">Fecha Entrada:</label>
                                      <input type="datetime-local" v-model="fecha_entrada_vehiculo" class="form-control form-control-sm" id="fecha_entrada" required readonly>
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="fecha_salida" class="form-label">Fecha Salida:</label>
                                      <input type="datetime-local" v-model="formLiquidacion.fecha" class="form-control form-control-sm" id="fecha_salida"
                                        @change="calcularPrecioHoras" required>
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="agente" class="form-label">Agente:</label>
                                      <input type="text" v-model="formLiquidacion.agente" class="form-control form-control-sm" id="agente"
                                        required pattern="[A-Za-zÀ-ÿ\s]{2,50}" title="El nombre del agente debe contener solo letras y espacios (2-50 caracteres)">
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="importe_retirada" class="form-label">Importe Retirada:</label>
                                      <input type="number" disabled v-model="formLiquidacion.importe_retirada" class="form-control form-control-sm" id="importe_retirada" required>
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="importe_deposito" class="form-label">Importe Deposito:</label>
                                      <input type="number" disabled v-model="formLiquidacion.importe_deposito" class="form-control form-control-sm" id="importe_deposito"
                                        required step="0.01" min="0" max="9999.99" title="El importe debe ser un número positivo con hasta 2 decimales">
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="total" class="form-label">Total:</label>
                                      <input type="number" disabled v-model="formLiquidacion.total" class="form-control form-control-sm" id="total"
                                        required step="0.01" min="0" max="99999.99" title="El total debe ser un número positivo con hasta 2 decimales">
                                    </div>

                                    <div class="form-group mb-2">
                                      <label for="opciones_pago" class="form-label">Opciones Pago:</label>
                                      <select v-model="formLiquidacion.opciones_pago" class="form-control form-control-sm" id="opciones_pago" required>
                                        <option value="Metálico">Metálico</option>
                                        <option value="Tarjeta">Tarjeta</option>
                                        <option value="Bizum">Bizum</option>
                                      </select>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-primary">Crear liquidación</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <!-- Crear vehiculo -->
                    <div class="modal fade" id="retiradaCrearModal" tabindex="-1" role="dialog" aria-labelledby="retiradaCrearModalLabel" aria-hidden="true">
                      <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="retiradaCrearModalLabel">Creación de Vehículo</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <form @submit.prevent="crearRetirada" id="formRetirada" class="modal-body needs-validation">
                            <div class="container-fluid">
                              <div class="row">
                                <!-- Columna izquierda -->
                                <div class="col-md-6">
                                  <div class="form-group mb-2">
                                    <label for="id" class="form-label">ID:</label>
                                    <input type="text" :value="formRetirada.id" class="form-control form-control-sm" id="id" disabled>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="fecha_entrada" class="form-label">Fecha de Entrada:</label>
                                    <input type="datetime-local" v-model="formRetirada.fecha_entrada" class="form-control form-control-sm" id="fecha_entrada" required>
                                    <div class="invalid-feedback">La fecha de entrada es requerida</div>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="fecha_salida" class="form-label">Fecha de Salida:</label>
                                    <input type="datetime-local" v-model="formRetirada.fecha_salida" disabled 
                                          class="form-control form-control-sm" id="fecha_salida">
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="lugar" class="form-label">Lugar:</label>
                                    <input type="text" v-model="formRetirada.lugar" class="form-control form-control-sm" 
                                          id="lugar" required minlength="3" maxlength="100"
                                          pattern="[A-Za-zÀ-ÿ\s]{3,100}">
                                    <div class="invalid-feedback">El lugar debe contener entre 3 y 100 caracteres, solo letras y espacios</div>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="direccion" class="form-label">Dirección:</label>
                                    <input type="text" v-model="formRetirada.direccion" class="form-control form-control-sm" 
                                          id="direccion" required minlength="5" maxlength="200">
                                    <div class="invalid-feedback">La dirección debe contener entre 5 y 200 caracteres</div>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="agente" class="form-label">Agente:</label>
                                    <input type="text" v-model="formRetirada.agente" class="form-control form-control-sm" 
                                          id="agente" required minlength="3" maxlength="50"
                                          pattern="[A-Za-zÀ-ÿ\s]{3,50}">
                                    <div class="invalid-feedback">El nombre del agente debe contener entre 3 y 50 caracteres, solo letras y espacios</div>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="matricula" class="form-label">Matrícula:</label>
                                    <input type="text" v-model="formRetirada.matricula" class="form-control form-control-sm" 
                                          id="matricula" required
                                          pattern="[0-9]{4}[A-Z]{3}|[A-Z]{1,2}[0-9]{4}[A-Z]{1,2}">
                                    <div class="invalid-feedback">Formato de matrícula inválido. Debe ser 1234ABC o AB1234C</div>
                                  </div>
                                </div>
                                
                                <!-- Columna derecha -->
                                <div class="col-md-6">
                                  <div class="form-group mb-2">
                                    <label for="marca" class="form-label">Marca:</label>
                                    <input type="text" v-model="formRetirada.marca" class="form-control form-control-sm" 
                                          id="marca" required minlength="2" maxlength="50">
                                    <div class="invalid-feedback">La marca debe contener entre 2 y 50 caracteres</div>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="modelo" class="form-label">Modelo:</label>
                                    <input type="text" v-model="formRetirada.modelo" class="form-control form-control-sm" 
                                          id="modelo" required minlength="1" maxlength="50">
                                    <div class="invalid-feedback">El modelo debe contener entre 1 y 50 caracteres</div>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="color" class="form-label">Color:</label>
                                    <input type="text" v-model="formRetirada.color" class="form-control form-control-sm" 
                                          id="color" required minlength="3" maxlength="20"
                                          pattern="[A-Za-zÀ-ÿ\s]{3,20}">
                                    <div class="invalid-feedback">El color debe contener entre 3 y 20 caracteres, solo letras</div>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="motivo" class="form-label">Motivo:</label>
                                    <input type="text" v-model="formRetirada.motivo" class="form-control form-control-sm" 
                                          id="motivo" required minlength="5" maxlength="200">
                                    <div class="invalid-feedback">El motivo debe contener entre 5 y 200 caracteres</div>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="tipo_vehiculo" class="form-label">Tipo de Vehículo:</label>
                                    <select v-model="formRetirada.tipo_vehiculo" class="form-control form-control-sm" 
                                            id="tipo_vehiculo" required>
                                      <option value="" disabled selected>Seleccione tipo de vehículo</option>
                                      <option value="Motocicleta, aperos, motocarros y similares">Motocicleta, aperos, motocarros y similares</option>
                                      <option value="Turismo hasta 12 cv o Remolques hasta 750 kg">Turismo hasta 12 cv o Remolques hasta 750 kg</option>
                                      <option value="Turismos más de 12 cv o Remolques más de 750 kg">Turismos más de 12 cv o Remolques más de 750 kg</option>
                                      <option value="Vehiculos especiales">Vehículos especiales</option>
                                      <option value="Vehiculos de cortesia">Vehiculos de cortesia</option>
                                      <option value="Chatarra">Chatarra</option>
                                    </select>
                                    <div class="invalid-feedback">Debe seleccionar un tipo de vehículo</div>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="grua" class="form-label">Grúa:</label>
                                    <select v-model="formRetirada.grua" class="form-control form-control-sm" 
                                            id="grua" required>
                                      <option value="" disabled selected>Seleccione grua usada</option>
                                      <option value="Grua Este">Grua Este</option>
                                      <option value="Grua Norte">Grua Norte</option>
                                      <option value="Grua Ajandemol">Grua Ajandemol</option>
                                      <option value="Grua Omega">Grua Omega</option>
                                      <option value="Grua Sigma">Grua Sigma</option>
                                    </select>
                                    <div class="invalid-feedback">Debe seleccionar una grúa</div>
                                  </div>
                                  <div class="form-group mb-2">
                                    <label for="estado" class="form-label">Estado:</label>
                                    <select v-model="formRetirada.estado" class="form-control form-control-sm" 
                                            id="estado" disabled>
                                      <option value="En depósito">En depósito</option>
                                      <option value="Retirado">Retirado</option>
                                    </select>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-primary">Crear retirada</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <!-- Eliminar vehiculo -->
                    <div class="modal fade" id="retiradaEliminarModal" tabindex="-1" role="dialog" aria-labelledby="retiradaEliminarModalLabel" aria-hidden="true">
                      <div class="modal-dialog modal-xl" role="document">
                          <div class="modal-content">
                              <div class="modal-header">
                                  <h5 class="modal-title" id="retiradaEliminarModalLabel">Eliminación de vehículo</h5>
                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                      <span aria-hidden="true">&times;</span>
                                  </button>
                              </div>
                              <div class="modal-body">
                                <div class="row">
                                  <div class="col-md-12 mb-6">
                                    <h5>¿Estás seguro de que quieres eliminar la retirada Nº{{retirada_seleccionada.id}}?</h5>
                                  </div>
                                </div>
                            </div>
                              <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                                  <button type="button" class="btn btn-danger" @click="eliminarRetirada">Eliminar retirada</button>
                              </div>
                          </div>
                      </div>
                    </div>

                    <!-- Editar vehiculo -->
                    <div class="modal fade" id="retiradaEditarModal" tabindex="-1" role="dialog" aria-labelledby="retiradaEditarModalLabel" aria-hidden="true">
                      <div class="modal-dialog modal-xl" role="document">
                          <div class="modal-content">
                              <div class="modal-header">
                                  <h5 class="modal-title" id="retiradaEditarModalLabel">Modificación de vehículo</h5>
                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                      <span aria-hidden="true">&times;</span>
                                  </button>
                              </div>
                              <form @submit.prevent="editarRetirada" class="needs-validation">
                                <div class="modal-body">
                                  <div class="container-fluid">
                                    <div class="row">
                                      <!-- Left Column -->
                                      <div class="col-md-6">
                                        <div class="form-group mb-3">
                                          <label for="id" class="form-label">ID:</label>
                                          <input type="text" v-model="retirada_seleccionada.id" class="form-control" id="id" required disabled>
                                        </div>
                                        <div class="form-group mb-3" v-if="retirada_seleccionada.fecha_salida == null">
                                          <label for="fecha_entrada" class="form-label" >Fecha de Entrada:</label>
                                          <input type="datetime-local" v-model="retirada_seleccionada.fecha_entrada" class="form-control" id="fecha_entrada" required>
                                          <div class="invalid-feedback">La fecha de entrada es requerida</div>
                                        </div>
                                        <div class="form-group mb-3" v-else>
                                          <label for="fecha_entrada" class="form-label" >Fecha de Entrada:</label>
                                          <input type="datetime-local" v-model="retirada_seleccionada.fecha_entrada" class="form-control" id="fecha_entrada" required readonly>
                                          <div class="invalid-feedback">La fecha de entrada es requerida</div>
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="fecha_salida" class="form-label">Fecha de Salida:</label>
                                          <input type="datetime-local" v-model="retirada_seleccionada.fecha_salida" class="form-control" id="fecha_salida" disabled>
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="lugar" class="form-label">Lugar:</label>
                                          <input type="text" v-model="retirada_seleccionada.lugar" class="form-control" id="lugar" required
                                            pattern="[A-Za-zÀ-ÿ\s]{3,100}" title="El lugar debe contener entre 3 y 100 caracteres, solo letras y espacios">
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="direccion" class="form-label">Dirección:</label>
                                          <input type="text" v-model="retirada_seleccionada.direccion" class="form-control" id="direccion" required
                                            minlength="5" maxlength="200">
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="agente" class="form-label">Agente:</label>
                                          <input type="text" v-model="retirada_seleccionada.agente" class="form-control" id="agente" required
                                            pattern="[A-Za-zÀ-ÿ\s]{3,50}">
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="matricula" class="form-label">Matrícula:</label>
                                          <input type="text" v-model="retirada_seleccionada.matricula" class="form-control" id="matricula" required
                                            pattern="[0-9]{4}[A-Z]{3}|[A-Z]{1,2}[0-9]{4}[A-Z]{1,2}">
                                        </div>
                                      </div>
                                      
                                      <!-- Right Column -->
                                      <div class="col-md-6">
                                        <div class="form-group mb-3">
                                          <label for="marca" class="form-label">Marca:</label>
                                          <input type="text" v-model="retirada_seleccionada.marca" class="form-control" id="marca" required
                                            minlength="2" maxlength="50">
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="modelo" class="form-label">Modelo:</label>
                                          <input type="text" v-model="retirada_seleccionada.modelo" class="form-control" id="modelo" required
                                            minlength="2" maxlength="50">
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="color" class="form-label">Color:</label>
                                          <input type="text" v-model="retirada_seleccionada.color" class="form-control" id="color" required
                                            pattern="[A-Za-zÀ-ÿ\s]{3,20}">
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="motivo" class="form-label">Motivo:</label>
                                          <input type="text" v-model="retirada_seleccionada.motivo" class="form-control" id="motivo" required
                                            minlength="5" maxlength="200">
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="tipo_vehiculo" class="form-label">Tipo de Vehículo:</label>
                                          <select v-model="retirada_seleccionada.tipo_vehiculo" class="form-control" id="tipo_vehiculo" required>
                                            <option value="">Seleccione tipo de vehículo</option>
                                            <option value="Motocicleta, aperos, motocarros y similares">Motocicleta, aperos, motocarros y similares</option>
                                            <option value="Turismo hasta 12 cv o Remolques hasta 750 kg">Turismo hasta 12 cv o Remolques hasta 750 kg</option>
                                            <option value="Turismos más de 12 cv o Remolques más de 750 kg">Turismos más de 12 cv o Remolques más de 750 kg</option>
                                            <option value="Vehiculos especiales">Vehículos especiales</option>
                                            <option value="Vehiculos de cortesia">Vehiculos de cortesia</option>
                                            <option value="Chatarra">Chatarra</option>
                                          </select>
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="grua" class="form-label">Grúa:</label>
                                          <select v-model="retirada_seleccionada.grua" class="form-control" id="grua" required>
                                            <option value="">Seleccione grúa</option>
                                            <option value="Grua Este">Grua Este</option>
                                            <option value="Grua Norte">Grua Norte</option>
                                            <option value="Grua Ajandemol">Grua Ajandemol</option>
                                            <option value="Grua Omega">Grua Omega</option>
                                            <option value="Grua Sigma">Grua Sigma</option>
                                          </select>
                                        </div>
                                        <div class="form-group mb-3">
                                          <label for="estado" class="form-label">Estado:</label>
                                          <select v-model="retirada_seleccionada.estado" class="form-control" id="estado" disabled>
                                            <option value="En depósito">En depósito</option>
                                            <option value="Retirado">Retirado</option>
                                          </select>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                                  <button type="submit" class="btn btn-warning">Editar retirada</button>
                                </div>
                              </form>
                          </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Gestión de usuarios (admin) -->
                <div v-if="pantalla === 'usuarios'">
                  <h1 class="text-center">Gestión de usuarios</h1>
                  <h3><button @click="formularioCrearUsuario" data-toggle="modal" data-target="#createModal" class="btn btn-primary mt-3 w-100 p-3 mb-3 align-text-center">Crear usuario</button></h3>
                  <!-- Tabla usuarios -->
                  <div class="table-responsive">
                      <div>
                      <!-- Search and length controls -->
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <div class="dataTables_length">
                            <label>
                              Show 
                              <select v-model="pageSize" class="form-select form-select-sm">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                              </select>
                              entries
                            </label>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="dataTables_filter">
                            <label>
                              Search:
                              <input type="search" v-model="searchQuery" class="form-control form-control-sm">
                            </label>
                          </div>
                        </div>
                      </div>

                      <!-- Table -->
                      <table class="table table-striped table-bordered shadow-sm text-center">
                        <thead class="table-dark">
                          <tr>
                            <th v-for="column in columns" 
                                @click="sortBy(column.field)"
                                class="align-middle text-center"
                                :class="{ 'sorting': currentSort === column.field }">
                              {{ column.label }}
                              <span v-if="currentSort === column.field">
                                {{ currentSortDir === 'asc' ? '▲' : '▼' }}
                              </span>
                            </th>
                            <th class="align-middle text-center" colspan="2">Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="usuario in paginatedAndFilteredUsers" class="align-middle">
                            <td class="text-center">{{ usuario.id }}</td>
                            <td class="text-center">{{ usuario.email }}</td>
                            <td class="text-center">{{ usuario.password }}</td>
                            <td class="text-center">
                              <span class="badge" :class="{
                                'bg-danger': usuario.rol === 'administrador',
                                'bg-secondary': usuario.rol === 'operario'
                              }">
                                {{ usuario.rol === 'administrador' ? 'Administrador' : 'Operario' }}
                              </span>
                            </td>
                            <td class="text-center">
                              <button @click="formularioEditarUsuario(usuario.id)" 
                                      class="btn btn-primary btn-sm" 
                                      data-toggle="modal" 
                                      data-target="#editModal">
                                <i class="fas fa-edit me-1"></i> Editar
                              </button>
                            </td>
                            <td class="text-center">
                              <button @click="formularioEliminarUsuario(usuario.id)" 
                                      class="btn btn-danger btn-sm" 
                                      data-toggle="modal" 
                                      data-target="#deleteModal">
                                <i class="fas fa-trash-alt me-1"></i> Eliminar
                              </button>
                            </td>
                          </tr>
                        </tbody>
                      </table>

                      <!-- Pagination -->
                      <div class="row">
                        <div class="col-md-6">
                          <div class="dataTables_info">
                            Showing {{ startIndex + 1 }} to {{ endIndex }} of {{ filteredUsers.length }} entries
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="dataTables_paginate">
                            <ul class="pagination justify-content-end">
                              <li class="page-item" :class="{ disabled: currentPage === 1 }">
                                <a class="page-link" href="#" @click.prevent="currentPage--">Previous</a>
                              </li>
                              <li v-for="page in totalPages" 
                                  class="page-item"
                                  :class="{ active: currentPage === page }">
                                <a class="page-link" href="#" @click.prevent="currentPage = page">{{ page }}</a>
                              </li>
                              <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                                <a class="page-link" href="#" @click.prevent="currentPage++">Next</a>
                              </li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Modal crear usuario -->
                  <div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="createModalLabel">Creación de usuario</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <form @submit.prevent="crearUsuario" class="modal-body">
                                <div class="form-group mb-3">
                                    <label for="email">Email:</label>
                                    <input type="email" 
                                           id="email"
                                           class="form-control" 
                                           v-model="email"
                                           required
                                           title="Por favor introduzca un email válido" />
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="password">Contraseña:</label>
                                    <input type="password"
                                           id="password" 
                                           class="form-control" 
                                           v-model="contrasena"
                                           required
                                           minlength="8"
                                           pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}"
                                           title="La contraseña debe contener al menos 1 mayúscula, 1 minúscula y 8 carácteres" />
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="rol">Rol:</label>
                                    <select class="form-control"
                                            id="rol" 
                                            v-model="rol"
                                            required>
                                        <option value="">Selecciona un rol</option>
                                        <option value="administrador">Administrador</option>
                                        <option value="operario">Operario</option>
                                    </select>
                                </div>
                                
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">Crear usuario</button>
                                </div>
                            </form>
                        </div>
                    </div>
                  </div>
      
                  <!-- Modal editar usuario -->
                  <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="editModalLabel">Edición del usuario {{ usuario_seleccionado.email }}</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <form @submit.prevent="editarUsuario" class="modal-body">
                          <div class="form-group mb-3">
                            <label for="editEmail">Email:</label>
                            <input type="email" 
                                  id="editEmail"
                                  class="form-control" 
                                  v-model.trim="usuario_seleccionado.email"
                                  required
                                  title="Por favor introduzca un email válido" />
                          </div>

                          <div class="form-group mb-3">
                            <label for="editPassword">Contraseña:</label>
                            <input type="password"
                                  id="editPassword" 
                                  class="form-control" 
                                  v-model.trim="usuario_seleccionado.password"
                                  required
                                  minlength="8"
                                  pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}"
                                  title="La contraseña debe contener al menos 1 mayúscula, 1 minúscula y 8 carácteres" />
                          </div>

                          <div class="form-group mb-3">
                            <label for="editRol">Rol:</label>
                            <select class="form-control"
                                    id="editRol" 
                                    v-model="usuario_seleccionado.rol"
                                    required>
                                <option value="" disabled>Selecciona un rol</option>
                                <option value="administrador">Administrador</option>
                                <option value="operario">Operario</option>
                            </select>
                          </div>
                          
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar cambios</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
      
                  <!-- Modal eliminar usuario -->
                  <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="deleteModalLabel">Confirmar eliminación</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          ¿Está seguro de que desea eliminar al usuario {{  usuario_seleccionado.email }}?
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                          <button type="button" class="btn btn-danger" @click="eliminarUsuario">Eliminar</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </main>
          <footer class="bg-dark text-white text-center py-3">
            <div class="container">
              © 2025 Todos los derechos reservados:
              <a class="text-white text-decoration-none" href="#">docarmoelmejor.com</a>
            </div>
          </footer>
        </div>
      </div>
    </div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  </body>
</html>